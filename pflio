import pandas as pd

# Assuming final_df is your DataFrame

# Remove rows where 'parent' column is 0, 1, or 2
filtered_df = final_df[~final_df['parent'].isin([0, 1, 2])]

# Get the unique portfolio_ticker values
portfolio_tickers = filtered_df['portfolio_ticker'].unique()

# Create a new Excel writer object
with pd.ExcelWriter('output.xlsx') as writer:
    for ticker in portfolio_tickers:
        # Filter rows for each portfolio_ticker
        ticker_df = filtered_df[filtered_df['portfolio_ticker'] == ticker]
        
        # Select only the desired columns
        ticker_df = ticker_df[['security_description', 'cusip', 'pct_mv']]
        
        # Calculate the cash row
        cash_row = pd.DataFrame({
            'security_description': ['cash'],
            'cusip': [''],
            'pct_mv': [1 - ticker_df['pct_mv'].sum()]
        })
        
        # Append the cash row to the ticker_df
        ticker_df = pd.concat([ticker_df, cash_row], ignore_index=True)
        
        # Write the DataFrame to the Excel sheet named after the portfolio_ticker
        ticker_df.to_excel(writer, sheet_name=ticker, index=False)
